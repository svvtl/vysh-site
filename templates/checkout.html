{% extends "base.html" %}

{% block title %}–û—Ñ–æ—Ä–º–ª–µ–Ω–Ω—è –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è{% endblock %}

{% block content %}
<style>
  .checkout-layout {
    display: flex;
    gap: 30px;
    align-items: flex-start;
    flex-wrap: wrap;
  }

  .checkout-form {
    flex: 1;
    min-width: 300px;
  }

  .checkout-summary {
    flex: 1;
    min-width: 300px;
  }

  .grouped-buttons {
    display: flex;
    gap: 10px;
    margin-top: 20px;
    flex-wrap: wrap;
  }

  .primary-btn,
  .installment-btn {
    padding: 10px 20px;
    font-size: 16px;
    cursor: pointer;
  }

  .installment-btn {
    background-color: #f3f3f3;
    border: 1px solid #ccc;
    color: #333;
  }
</style>

<div class="checkout-page">
  <h1>–û—Ñ–æ—Ä–º–ª–µ–Ω–Ω—è –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</h1>

  {% if cart_items %}
  <div class="checkout-layout">

    <!-- –õ–Ü–í–ê –ß–ê–°–¢–ò–ù–ê -->
    <form id="checkoutForm" class="checkout-form" method="post">
      <h3>–ö–æ–Ω—Ç–∞–∫—Ç–Ω—ñ –¥–∞–Ω—ñ</h3>

      <label>
        –Ü–º º—è
        <input type="text" name="name" required>
      </label>

      <label>
        –¢–µ–ª–µ—Ñ–æ–Ω
        <input type="tel" name="phone" required>
      </label>

      <label>
        Email
        <input type="email" name="email">
      </label>

      <label>
        –ê–¥—Ä–µ—Å–∞ –¥–æ—Å—Ç–∞–≤–∫–∏
        <textarea name="address" rows="3" required></textarea>
      </label>

      <div class="grouped-buttons">
        <button type="submit" class="primary-btn">–ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</button>
        <button type="button" id="monoInstallmentBtn" class="installment-btn">–ü–æ–∫—É–ø–∫–∞ —á–∞—Å—Ç–∏–Ω–∞–º–∏</button>
      </div>
    </form>

    <!-- –ü–†–ê–í–ê –ß–ê–°–¢–ò–ù–ê -->
    <div class="checkout-summary">
      <h3>–í–∞—à–µ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</h3>
      <div class="order-number">
        –ù–æ–º–µ—Ä –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è: <strong>{{ store_order_id }}</strong>
      </div>
      {% for row in cart_items %}
      <div class="checkout-item">
        <span>{{ row.item.name }} √ó {{ row.qty }}</span>
        <span>{{ row.total }} ‚Ç¥</span>
      </div>
      {% endfor %}
      <div class="checkout-total">
        –†–∞–∑–æ–º: <strong>{{ total }} ‚Ç¥</strong>
      </div>
    </div>

  </div>
  {% else %}
  <p>–ö–æ—à–∏–∫ –ø–æ—Ä–æ–∂–Ω—ñ–π</p>
  <a href="/products">‚Üê –î–æ –∫–∞—Ç–∞–ª–æ–≥—É</a>
  {% endif %}
</div>

<!-- ‚úÖ JS –°–ö–†–ò–ü–¢ -->
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const installmentBtn = document.getElementById('monoInstallmentBtn');

    if (!installmentBtn) {
      console.log('‚ùå –ö–Ω–æ–ø–∫–∞ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–∞');
      return;
    }

    installmentBtn.addEventListener('click', async function (e) {
      e.preventDefault(); // ‚õî –ó–∞–±–æ—Ä–æ–Ω—è—î–º–æ —Å–∞–±–º—ñ—Ç —Ñ–æ—Ä–º–∏

      console.log('üì¶ MONO CLICK');

      const phoneInput = document.querySelector('input[name="phone"]');
      const phone = phoneInput ? phoneInput.value.trim() : '';

      if (!phone) {
        alert('–í–≤–µ–¥—ñ—Ç—å –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω—É');
        return;
      }

      try {
        const res = await fetch('/pay-parts', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ phone })
        });

        const data = await res.json();

        if (data.status === 'success') {
          window.location.href = '/order-success';
        } else {
          alert(data.message || '–ü–æ–º–∏–ª–∫–∞ –æ–ø–ª–∞—Ç–∏ —á–∞—Å—Ç–∏–Ω–∞–º–∏');
        }

      } catch (err) {
        alert('–ü–æ–º–∏–ª–∫–∞ –∑‚Äô—î–¥–Ω–∞–Ω–Ω—è –∑ —Å–µ—Ä–≤–µ—Ä–æ–º');
        console.error(err);
      }
    });
  });
</script>
{% endblock %}
